<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>白的插件市场 - 提交插件</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div x-data="pluginSubmit()" class="min-h-screen">
        <!-- 顶部横幅 -->
        <div class="gradient-bg text-white py-12 px-4">
            <div class="max-w-4xl mx-auto text-center">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-white/20 rounded-2xl mb-4">
                    <span class="text-5xl">🏪</span>
                </div>
                <h1 class="text-4xl font-bold mb-2">白的插件市场</h1>
                <p class="text-white/80 text-lg">提交你的插件，与所有白的用户分享</p>
                
                <!-- 跳转链接 -->
                <div class="flex justify-center gap-4 mt-6">
                    <a href="https://whitesalary-plugins-view.vercel.app" target="_blank"
                       class="bg-white/20 hover:bg-white/30 backdrop-blur rounded-xl px-5 py-2.5 flex items-center gap-2 transition-all">
                        <span>👀</span>
                        <span>浏览所有插件</span>
                    </a>
                    <a href="https://github.com/VBHC-UHY/whitesalary-plugins" target="_blank"
                       class="bg-white/10 hover:bg-white/20 backdrop-blur rounded-xl px-5 py-2.5 flex items-center gap-2 transition-all">
                        <span>📂</span>
                        <span>GitHub</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 主内容 -->
        <div class="max-w-4xl mx-auto px-4 -mt-8 pb-12">
            <div class="bg-white rounded-2xl card-shadow overflow-hidden">
                <!-- 步骤指示器 -->
                <div class="bg-gray-50 px-6 py-4 border-b flex items-center justify-center gap-4">
                    <div class="flex items-center gap-2" :class="step >= 1 ? 'text-purple-600' : 'text-gray-400'">
                        <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" 
                              :class="step >= 1 ? 'bg-purple-600 text-white' : 'bg-gray-200'">1</span>
                        <span class="font-medium">基本信息</span>
                    </div>
                    <div class="w-12 h-0.5" :class="step >= 2 ? 'bg-purple-600' : 'bg-gray-200'"></div>
                    <div class="flex items-center gap-2" :class="step >= 2 ? 'text-purple-600' : 'text-gray-400'">
                        <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                              :class="step >= 2 ? 'bg-purple-600 text-white' : 'bg-gray-200'">2</span>
                        <span class="font-medium">功能描述</span>
                    </div>
                    <div class="w-12 h-0.5" :class="step >= 3 ? 'bg-purple-600' : 'bg-gray-200'"></div>
                    <div class="flex items-center gap-2" :class="step >= 3 ? 'text-purple-600' : 'text-gray-400'">
                        <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                              :class="step >= 3 ? 'bg-purple-600 text-white' : 'bg-gray-200'">3</span>
                        <span class="font-medium">插件代码</span>
                    </div>
                </div>
                
                <!-- 表单内容 -->
                <div class="p-6">
                    <!-- 步骤1：基本信息 -->
                    <div x-show="step === 1" x-transition>
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-2xl">📝</span> 基本信息
                        </h2>
                        <!-- 简要说明 -->
                        <div class="bg-purple-50 rounded-lg px-4 py-2 mb-4 text-sm text-purple-700">
                            💡 <b>带 * 为必填</b>。插件ID用于文件夹命名，名称是用户看到的标题。
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    插件ID <span class="text-red-500">*</span>
                                </label>
                                <input type="text" x-model="form.id" placeholder="如：daily_fortune、dice_roll"
                                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                                <p class="text-xs text-gray-400 mt-1">小写字母+数字+下划线，字母开头</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    插件名称 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" x-model="form.cn_name" placeholder="如：每日运势、骰子插件"
                                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                                <p class="text-xs text-gray-400 mt-1">显示在插件市场的中文名称</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    作者名称 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" x-model="form.author" placeholder="你的昵称或ID"
                                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">版本号</label>
                                <input type="text" x-model="form.version" placeholder="1.0.0"
                                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                                <p class="text-xs text-gray-400 mt-1">格式：主版本.次版本.修订号</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                                <select x-model="form.category"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                                    <optgroup label="🎯 热门分类">
                                        <option value="娱乐游戏">🎮 娱乐游戏</option>
                                        <option value="实用工具">🛠️ 实用工具</option>
                                        <option value="社交互动">💬 社交互动</option>
                                        <option value="AI增强">🤖 AI增强</option>
                                    </optgroup>
                                    <optgroup label="📺 媒体内容">
                                        <option value="音乐音频">🎵 音乐音频</option>
                                        <option value="图片处理">🖼️ 图片处理</option>
                                        <option value="视频相关">📹 视频相关</option>
                                        <option value="媒体综合">📺 媒体综合</option>
                                    </optgroup>
                                    <optgroup label="📰 信息资讯">
                                        <option value="新闻资讯">📰 新闻资讯</option>
                                        <option value="天气日历">🌤️ 天气日历</option>
                                        <option value="网络搜索">🔍 网络搜索</option>
                                        <option value="翻译语言">🌐 翻译语言</option>
                                    </optgroup>
                                    <optgroup label="⚡ 效率提升">
                                        <option value="自动化">⚡ 自动化</option>
                                        <option value="提醒备忘">⏰ 提醒备忘</option>
                                        <option value="数据处理">📊 数据处理</option>
                                        <option value="开发工具">💻 开发工具</option>
                                    </optgroup>
                                    <optgroup label="🎲 趣味休闲">
                                        <option value="占卜算命">🔮 占卜算命</option>
                                        <option value="趣味恶搞">🃏 趣味恶搞</option>
                                        <option value="角色扮演">🎭 角色扮演</option>
                                        <option value="抽奖随机">🎰 抽奖随机</option>
                                    </optgroup>
                                    <optgroup label="🏠 生活服务">
                                        <option value="生活服务">🏠 生活服务</option>
                                        <option value="学习教育">📚 学习教育</option>
                                        <option value="财务金融">💰 财务金融</option>
                                        <option value="健康运动">💪 健康运动</option>
                                    </optgroup>
                                    <optgroup label="👥 群组管理">
                                        <option value="群管理">👮 群管理</option>
                                        <option value="数据统计">📈 数据统计</option>
                                        <option value="群互动">🎉 群互动</option>
                                    </optgroup>
                                    <optgroup label="🔧 其他">
                                        <option value="系统管理">⚙️ 系统管理</option>
                                        <option value="其他">📦 其他</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    简短介绍 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" x-model="form.description" placeholder="如：每天生成个性化运势预测，包含爱情、财运、事业等多维度"
                                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                                <p class="text-xs text-gray-400 mt-1">一句话概括插件功能，显示在列表中</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤2：功能描述 -->
                    <div x-show="step === 2" x-transition x-cloak>
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-2xl">✨</span> 功能描述
                        </h2>
                        <!-- 简要说明 -->
                        <div class="bg-green-50 rounded-lg px-4 py-2 mb-4 text-sm text-green-700">
                            💡 这些信息会显示在插件详情页，帮助用户了解如何使用。<b>都是选填</b>，但填写完整更容易被用户安装。
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">详细介绍</label>
                                <textarea x-model="form.full_description" rows="3" placeholder="详细描述插件能做什么、有什么特点、适合什么场景使用..."
                                          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all"></textarea>
                                <p class="text-xs text-gray-400 mt-1">比简短介绍更详细的说明，不填则使用简短介绍</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">功能特色</label>
                                <textarea x-model="form.features_text" rows="4" placeholder="🎲 支持多种骰子类型（D4/D6/D8/D10/D12/D20）&#10;🔢 可以同时投掷多个骰子&#10;📊 自动统计和计算结果"
                                          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all font-mono text-sm"></textarea>
                                <p class="text-xs text-gray-400 mt-1">每行一个特色功能，建议加emoji更直观</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">使用方法</label>
                                <textarea x-model="form.usage" rows="2" placeholder="对白说「今日运势」「帮我算一卦」等即可触发，白会返回详细的运势分析"
                                          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all"></textarea>
                                <p class="text-xs text-gray-400 mt-1">告诉用户怎么触发这个插件、会得到什么结果</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">触发命令</label>
                                <input type="text" x-model="form.commands_text" placeholder="今日运势, 运势, 算卦, 今天运气怎么样"
                                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                                <p class="text-xs text-gray-400 mt-1">用逗号分隔，用户说这些话会触发插件</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">更新日志</label>
                                    <input type="text" x-model="form.changelog" placeholder="v1.0.0 - 初始版本"
                                           class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">注意事项</label>
                                    <input type="text" x-model="form.notes" placeholder="如：需要联网、仅供娱乐参考等"
                                           class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤3：插件代码 -->
                    <div x-show="step === 3" x-transition x-cloak>
                        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-2xl">💻</span> 插件代码 <span class="text-red-500">*</span>
                        </h2>
                        <!-- 简要说明 -->
                        <div class="bg-blue-50 rounded-lg px-4 py-2 mb-4 text-sm text-blue-700">
                            💡 点击<b>「加载模板」</b>获取标准代码结构，然后修改其中的逻辑。代码必须包含 <code class="bg-blue-100 px-1 rounded">Plugin</code> 类和 <code class="bg-blue-100 px-1 rounded">plugin</code> 实例。
                        </div>
                        <div class="relative">
                            <div class="absolute top-2 right-2 z-10">
                                <button @click="loadTemplate()" class="px-4 py-2 bg-purple-100 text-purple-600 rounded-lg text-sm hover:bg-purple-200 transition-colors font-medium">
                                    📄 加载模板
                                </button>
                            </div>
                            <textarea x-model="form.code" rows="20" placeholder="# 在这里粘贴你的 plugin.py 代码...&#10;# 点击右上角「加载模板」获取标准结构"
                                      class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 transition-all font-mono text-sm bg-gray-900 text-green-400"></textarea>
                        </div>
                        <div class="mt-3 bg-gray-50 rounded-lg p-3 text-xs text-gray-600">
                            <b>代码要求：</b>
                            <span class="inline-flex items-center gap-1 ml-2">✅ 包含 <code class="bg-gray-200 px-1 rounded">class Plugin</code></span>
                            <span class="inline-flex items-center gap-1 ml-2">✅ 包含 <code class="bg-gray-200 px-1 rounded">can_handle()</code> 方法</span>
                            <span class="inline-flex items-center gap-1 ml-2">✅ 包含 <code class="bg-gray-200 px-1 rounded">handle()</code> 方法</span>
                            <span class="inline-flex items-center gap-1 ml-2">✅ 导出 <code class="bg-gray-200 px-1 rounded">plugin = Plugin()</code></span>
                        </div>
                    </div>
                </div>
                
                <!-- 底部按钮 -->
                <div class="px-6 py-4 bg-gray-50 border-t flex items-center justify-between">
                    <button x-show="step > 1" @click="step--" 
                            class="px-6 py-3 rounded-xl border border-gray-200 text-gray-600 hover:bg-white transition-colors">
                        ← 上一步
                    </button>
                    <div x-show="step === 1"></div>
                    
                    <button x-show="step < 3" @click="nextStep()"
                            class="px-6 py-3 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition-colors">
                        下一步 →
                    </button>
                    <button x-show="step === 3" @click="submit()" :disabled="submitting"
                            :class="submitting ? 'bg-gray-400 cursor-wait' : 'bg-green-600 hover:bg-green-700'"
                            class="px-8 py-3 rounded-xl text-white transition-colors flex items-center gap-2">
                        <span x-show="submitting" class="animate-spin">⏳</span>
                        <span x-text="submitting ? '提交中...' : '🚀 提交插件'"></span>
                    </button>
                </div>
            </div>
            
            <!-- 提示信息 -->
            <div class="mt-6 bg-blue-50 rounded-xl p-4 border border-blue-100">
                <h3 class="font-medium text-blue-800 flex items-center gap-2">
                    <span>💡</span> 提交须知
                </h3>
                <ul class="mt-2 text-sm text-blue-700 space-y-1">
                    <li>• 插件提交后会自动同步到插件市场</li>
                    <li>• 请确保代码可正常运行，不包含恶意内容</li>
                    <li>• 插件ID必须是唯一的，只能包含小写字母、数字和下划线</li>
                </ul>
            </div>
        </div>
        
        <!-- Toast 提示 -->
        <div x-show="toast.show" x-transition x-cloak
             class="fixed bottom-6 right-6 px-6 py-4 rounded-xl shadow-lg"
             :class="toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
            <span x-text="toast.message"></span>
        </div>
        
        <!-- 成功弹窗 -->
        <div x-show="showSuccess" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <div class="text-6xl mb-4">🎉</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">提交成功！</h2>
                <p class="text-gray-600 mb-6">你的插件已经提交到插件市场，所有用户现在都能看到了！</p>
                <button @click="showSuccess = false; resetForm()" 
                        class="px-8 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors">
                    继续提交
                </button>
            </div>
        </div>
    </div>
    
    <script>
    function pluginSubmit() {
        return {
            step: 1,
            submitting: false,
            showSuccess: false,
            toast: { show: false, message: '', type: 'success' },
            form: {
                id: '',
                cn_name: '',
                author: '',
                version: '1.0.0',
                category: '娱乐游戏',
                description: '',
                full_description: '',
                features_text: '',
                usage: '',
                commands_text: '',
                changelog: 'v1.0.0 - 初始版本',
                notes: '',
                code: ''
            },
            
            showToast(message, type = 'success') {
                this.toast = { show: true, message, type };
                setTimeout(() => this.toast.show = false, 3000);
            },
            
            nextStep() {
                if (this.step === 1) {
                    if (!this.form.id || !this.form.cn_name || !this.form.author || !this.form.description) {
                        this.showToast('请填写所有必填项', 'error');
                        return;
                    }
                    if (!/^[a-z][a-z0-9_]*$/.test(this.form.id)) {
                        this.showToast('插件ID只能包含小写字母、数字和下划线，且必须以字母开头', 'error');
                        return;
                    }
                }
                this.step++;
            },
            
            loadTemplate() {
                this.form.code = `"""
${this.form.cn_name || '插件名称'}
描述：${this.form.description || '这个插件做什么'}
作者：${this.form.author || '你的名字'}
"""

import re
from typing import Optional, Dict, Any


class Plugin:
    """插件主类"""
    
    def __init__(self):
        self.name = "${this.form.id || 'my_plugin'}"
        self.cn_name = "${this.form.cn_name || '插件中文名'}"
        self.description = "${this.form.description || '插件描述'}"
        self.version = "${this.form.version || '1.0.0'}"
        self.author = "${this.form.author || '作者'}"
        
        # 触发关键词（正则表达式）
        self.triggers = [
            r"关键词1",
            r"关键词2",
        ]
    
    def can_handle(self, message: str) -> bool:
        """检查是否应该处理这条消息"""
        for trigger in self.triggers:
            if re.search(trigger, message, re.IGNORECASE):
                return True
        return False
    
    async def handle(self, message: str, context: Dict[str, Any]) -> Optional[str]:
        """
        处理消息并返回响应
        
        Args:
            message: 用户发送的消息
            context: 上下文信息
        
        Returns:
            响应文本，或 None 表示不响应
        """
        # 在这里实现你的逻辑
        return "这是插件的回复！"


# 导出插件实例
plugin = Plugin()
`;
            },
            
            resetForm() {
                this.step = 1;
                this.form = {
                    id: '',
                    cn_name: '',
                    author: '',
                    version: '1.0.0',
                    category: '娱乐游戏',
                    description: '',
                    full_description: '',
                    features_text: '',
                    usage: '',
                    commands_text: '',
                    changelog: 'v1.0.0 - 初始版本',
                    notes: '',
                    code: ''
                };
            },
            
            async submit() {
                if (!this.form.code) {
                    this.showToast('请填写插件代码', 'error');
                    return;
                }
                
                this.submitting = true;
                
                try {
                    const features = this.form.features_text
                        .split('\n')
                        .map(f => f.trim())
                        .filter(f => f);
                    
                    const commands = this.form.commands_text
                        .split(/[,，]/)
                        .map(c => c.trim())
                        .filter(c => c);
                    
                    const res = await fetch('/api/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: this.form.id,
                            cn_name: this.form.cn_name,
                            author: this.form.author,
                            version: this.form.version,
                            category: this.form.category,
                            description: this.form.description,
                            full_description: this.form.full_description || this.form.description,
                            features: features,
                            usage: this.form.usage,
                            commands: commands,
                            changelog: this.form.changelog,
                            notes: this.form.notes,
                            code: this.form.code
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (data.success) {
                        this.showSuccess = true;
                    } else {
                        this.showToast(data.error || '提交失败', 'error');
                    }
                } catch (e) {
                    this.showToast('提交失败: ' + e.message, 'error');
                } finally {
                    this.submitting = false;
                }
            }
        }
    }
    </script>
</body>
</html>

